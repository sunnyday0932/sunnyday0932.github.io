<!DOCTYPE html>
<html lang="zh-tw">
  <head>	
  	
  
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-167497206-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-167497206-1');
</script>
	
  	
  <script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>	
  <meta http-equiv="content-type" content="text/html;charset=utf-8">	
  <meta http-equiv="X-UA-Compatible" content="chrome=1">	
  <meta name="viewport" content="width=device-width, initial-scale=1.0">	
  <meta name="robots" content="noodp"/>	
  <meta name="author" content="Sian">	
  <meta name="description" content="想成為PM的PG">	
  <meta name="keywords" content="Sian">	
  	
  <link rel="prev" href="https://sunnyday0932.github.io/2021/coreprofiler-%E7%9B%A3%E7%9C%8Bwebapi%E6%95%88%E8%83%BD%E7%9A%84%E5%B7%A5%E5%85%B7/" />	
  <link rel="next" href="https://sunnyday0932.github.io/2021/webapi-%E5%8A%A0%E5%85%A5%E5%BF%AB%E5%8F%96-2%E4%BD%BF%E7%94%A8%E8%A3%9D%E9%A3%BE%E8%80%85%E6%A8%A1%E5%BC%8F/" />	
  <link rel="canonical" href="https://sunnyday0932.github.io/2021/webapi-%E5%8A%A0%E5%85%A5%E5%BF%AB%E5%8F%96-1/" />	
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">	
  <link rel="icon" type="image/png" sizes="32x32" href="/images/me/favicon.ico">	
  <link rel="icon" type="image/png" sizes="16x16" href="/images/me/favicon.ico">	
  <link rel="manifest" href="/images/manifest.json" crossorigin="use-credentials">	
  <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">	
  <meta name="msapplication-TileColor" content="#da532c">	
  <meta name="theme-color" content="#ffffff">	
  <title>	
       	
       	
           WebApi 加入快取 - 1 | Sian	
       	
  </title>	
  <meta name="title" content="WebApi 加入快取 - 1 | Sian">	
    
  
  <link rel="stylesheet" href="/font/iconfont.css">
  <link rel="stylesheet" href="/css/main.min.css">

	
  	
  
 

<script type="application/ld+json">
{
    "@context" : "http://schema.org",
    "@type" : "BlogPosting",
    "mainEntityOfPage": {
         "@type": "WebPage",
         "@id": "https:\/\/sunnyday0932.github.io"
    },
    "articleSection" : "posts",
    "name" : "WebApi 加入快取 - 1",
    "headline" : "WebApi 加入快取 - 1",
    "description" : "WebApi 加入快取 - 1",
    "inLanguage" : "zh-tw",
    "author" : "Sian",
    "creator" : "Sian",
    "publisher": "Sian",
    "accountablePerson" : "Sian",
    "copyrightHolder" : "Sian",
    "copyrightYear" : "2021",
    "datePublished": "2021-04-30 01:40:45  UTC",
    "dateModified" : "2021-04-30 01:40:45  UTC",
    "url" : "https:\/\/sunnyday0932.github.io\/2021\/webapi-%E5%8A%A0%E5%85%A5%E5%BF%AB%E5%8F%96-1\/",
    "wordCount" : "3478",
    "keywords" : ["csharp","Core","dotnet","Cache", "Sian"]
}
</script>
	
</head>	
	
  	

  <body class="">
    <div class="wrapper">
        <nav class="navbar">
    <link rel="icon" type="image/png" href="/imgPath">
    <div class="container">
        <div class="navbar-header header-logo">
        	<a href="javascript:void(0);" class="theme-switch">🌙</a>&nbsp;<a href="https://sunnyday0932.github.io">Sian</a>
        </div>
        <div class="menu navbar-right">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
                <a class="menu-item" href="/recommend/" title="">Recommend</a>
                
        </div>
    </div>
</nav>
<nav class="navbar-mobile" id="nav-mobile" style="display: none">
     <div class="container">
        <div class="navbar-header">
            <div>  <a href="javascript:void(0);" class="theme-switch">🌙</a>&nbsp;<a href="https://sunnyday0932.github.io">Sian</a></div>
            <div class="menu-toggle">
                <span></span><span></span><span></span>
            </div>
        </div>
     
          <div class="menu" id="mobile-menu">
                
                
                <a class="menu-item" href="/posts/" title="">Blog</a>
                
                <a class="menu-item" href="/categories/" title="">Categories</a>
                
                <a class="menu-item" href="/tags/" title="">Tags</a>
                
                <a class="menu-item" href="/about/" title="">About</a>
                
                <a class="menu-item" href="/recommend/" title="">Recommend</a>
                
        </div>
    </div>
</nav>
    	 <main class="main">
          <div class="container">
      		
<article class="post-warp" itemscope itemtype="http://schema.org/Article">
    <header class="post-header">
        <h1 class="post-title" itemprop="name headline">WebApi 加入快取 - 1</h1>
        <div class="post-meta">
                Written by <a itemprop="name" href="https://sunnyday0932.github.io" rel="author">Sian</a>  
                <span class="post-time">
                on <time datetime=2021-04-30 itemprop="datePublished">April 30, 2021</time>
                </span>
                in
                <i class="iconfont icon-folder"></i>
                <span class="post-category">
                        <a href="https://sunnyday0932.github.io/categories/%E5%AD%B8%E7%BF%92%E7%AD%86%E8%A8%98/"> 學習筆記 </a>
                        
                </span>
                <span id="busuanzi_container_page_pv">
                    觀看次數:<span id="busuanzi_value_page_pv"></span>
                </span>
        </div>
        <meta name="referrer" content="no-referrer-when-downgrade">
    </header>
    <div class="post-content">
        

        
            
        

        
        
     
          
          
          

          
          
          

          <h2 id="前言">前言</h2>
<p>延續上次我們使用Hangfire排程抓取Youbike的練習題，這次我們要做一個Youbike的Service，專門提供查詢Youbike相關站點資訊的服務；前面製作排程的時候有提到因為Youbike站點資訊一分鐘才會更新一次，為了加快程式的查詢效率我們就可以將查詢的資料做成快取一分鐘在此期間加快查詢的效能。</p>
<h2 id="本文">本文</h2>
<h3 id="快取的使用時機">快取的使用時機</h3>
<p>當API效能遇到瓶頸的時候，就可以使用快取來減少不必要去DB撈取資料的動作，最常使用的會是記憶體快取、Redis快取等。</p>
<h3 id="快取的適用時機">快取的適用時機</h3>
<p>一般使用快取的功能通常是資料的變動性不大、不太會被變更的資料。</p>
<p>當然當某些特殊情境的情況下也可以使用快取Ex:購物節的時候電商網站等，那這種情況下就需要考慮到快取資料與我們DB資料同步的問題。</p>
<h3 id="快取的注意事項">快取的注意事項</h3>
<p>使用快取的方式簡單來說是用錢換取時間(記憶體比起硬碟貴了許多)，通常在放資料進快取的時候會需要注意資料的大小、能不能適度地進行切分，以及存放的過期時間，而不是拿了就丟全部放入快取內(當然如果你本多忠勝不在此限)。</p>
<h3 id="開始前準備">開始前準備</h3>
<p>這邊基本的API就不再進行示範，我們現在簡單的提供兩個功能，一個是查詢全部Youbike站點的功能、另一個是查詢指定Youbike站點的功能。</p>
<p>先看一下初始的Repository結構。</p>
<pre><code class="language-csharp=" data-lang="csharp=">        /// &lt;summary&gt;
        /// 取得全部Youbike站點
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public async Task&lt;IEnumerable&lt;StationDataModel&gt;&gt; GetAllStationAsync()
        {
            var sql = @&quot;SELECT [StationNo]
                              ,[StationName]
                              ,[Total]
                              ,[BikeAmount]
                              ,[StationArea]
                              ,[ModifyDate]
                              ,[Latitude]
                              ,[Longitude]
                              ,[Address]
                              ,[StationAreaEnglish]
                              ,[StationNameEnglish]
                              ,[AddressEnglish]
                              ,[Available]
                              ,[Active]
                              ,[SrcUpdateTime]
                              ,[UpdateTime]
                              ,[InfoTime]
                              ,[InfoDate]
                          FROM [Northwind].[dbo].[YoubikeStation]&quot;;

            using (var conn = this._databaseHelper.GetConnection(this._connectionString))
            {
                var result = await conn.QueryAsync&lt;StationDataModel&gt;(sql);

                return result;
            }
        }

        /// &lt;summary&gt;
        /// 取得指定Youbike站點
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;stationNo&quot;&gt;The station no.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public async Task&lt;StationDataModel&gt; GetStationAsync(string stationNo)
        {
            stationNo.CheckNotNullOrEmpty(nameof(stationNo));

            var sql = @&quot;SELECT [StationNo]
                              ,[StationName]
                              ,[Total]
                              ,[BikeAmount]
                              ,[StationArea]
                              ,[ModifyDate]
                              ,[Latitude]
                              ,[Longitude]
                              ,[Address]
                              ,[StationAreaEnglish]
                              ,[StationNameEnglish]
                              ,[AddressEnglish]
                              ,[Available]
                              ,[Active]
                              ,[SrcUpdateTime]
                              ,[UpdateTime]
                              ,[InfoTime]
                              ,[InfoDate]
                          FROM [Northwind].[dbo].[YoubikeStation]
                          WHERE StationNo = @StationNo&quot;;

            var parameter = new DynamicParameters();
            parameter.Add(&quot;@StationNo&quot;, stationNo, DbType.String);

            using (var conn = this._databaseHelper.GetConnection(this._connectionString))
            {
                var result = await conn.QueryFirstOrDefaultAsync&lt;StationDataModel&gt;(
                    sql,
                    parameter);

                return result;
            }
        }
</code></pre><h3 id="加入記憶體快取">加入記憶體快取</h3>
<p>這邊會示範簡單的加入記憶體快取。<br>
使用到的Nuget套件：</p>
<ul>
<li>Microsoft.Extensions.Caching.Memory</li>
<li>Microsoft.Extensions.Caching.Abstractions</li>
</ul>
<p>加入一個控制快取過期時間的方法。</p>
<pre><code class="language-csharp=" data-lang="csharp=">     /// &lt;summary&gt;
    /// Class CacheUtility.
    /// &lt;/summary&gt;
    public class CacheUtility
    {
        /// &lt;summary&gt;
        /// Gets the cache item Expiration (default: 5 min).
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;timeSpan&quot;&gt;The minutes.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static TimeSpan GetCacheItemExpiration(TimeSpan? timeSpan)
        {
            var absoluteExpiration = timeSpan is null
                ? TimeSpan.FromMinutes(5)
                : timeSpan.HasValue
                    ? TimeSpan.FromSeconds(timeSpan.Value.TotalSeconds)
                    : TimeSpan.FromMinutes(5);

            return absoluteExpiration;
        }

        /// &lt;summary&gt;
        /// Gets the cache item Expiration - 1 min.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;TimeSpan.&lt;/returns&gt;
        public static TimeSpan GetCacheItemExpiration1Min()
        {
            return TimeSpan.FromMinutes(1);
        }

        /// &lt;summary&gt;
        /// Gets the cache item Expiration - 5 min.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;TimeSpan.&lt;/returns&gt;
        public static TimeSpan GetCacheItemExpiration5Min()
        {
            return TimeSpan.FromMinutes(5);
        }

        /// &lt;summary&gt;
        /// Gets the cache item Expiration - 10 min.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static TimeSpan GetCacheItemExpiration10Min()
        {
            return TimeSpan.FromMinutes(10);
        }

        /// &lt;summary&gt;
        /// Gets the cache Expiration - 30 minutes.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static TimeSpan GetCacheItemExpiration30Min()
        {
            return TimeSpan.FromMinutes(30);
        }

        /// &lt;summary&gt;
        /// Gets the cache Expiration - one hour.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static TimeSpan GetCacheItemExpirationOneHour()
        {
            return TimeSpan.FromHours(1);
        }

        /// &lt;summary&gt;
        /// Gets the cache Expiration - 6 hour.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static TimeSpan GetCacheItemExpiration6Hour()
        {
            return TimeSpan.FromHours(6);
        }

        /// &lt;summary&gt;
        /// Gets the cache Expiration - one day.
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public static TimeSpan GetCacheItemExpirationOneDay()
        {
            return TimeSpan.FromDays(1);
        }
    }
</code></pre><p>接下來要建立一個快取共用的基底。<br>
建立ICacheProvider。</p>
<pre><code class="language-csharp=" data-lang="csharp=">    /// &lt;summary&gt;
    /// 
    /// &lt;/summary&gt;
    public interface ICacheProvider
    {
        /// &lt;summary&gt;
        /// Validates if an object with this key exists in the cache
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key of the object to check&lt;/param&gt;
        /// &lt;returns&gt;True if it exists, false if it doesn't&lt;/returns&gt;
        bool Exists(string key);

        /// &lt;summary&gt;
        /// Insert an item into the cache with no specifics as to how it will be used
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to map this object&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The value to be saved to the cache&lt;/param&gt;
        bool Save(string key, object value);

        /// &lt;summary&gt;
        /// Insert an item in the cache with the expiration that it will expire if not used past its window
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to map this object&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The object to insert&lt;/param&gt;
        /// &lt;param name=&quot;slidingExpiration&quot;&gt;The expiration window&lt;/param&gt;
        bool Save(string key, object value, TimeSpan slidingExpiration);

        /// &lt;summary&gt;
        /// Insert an item in the cache with the expiration that will expire at a specific point in time
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to map this object&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The object to insert&lt;/param&gt;
        /// &lt;param name=&quot;absoluteExpiration&quot;&gt;The DateTime in which this object will expire&lt;/param&gt;
        bool Save(string key, object value, DateTime absoluteExpiration);

        /// &lt;summary&gt;
        /// Saves the specified key.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The value.&lt;/param&gt;
        /// &lt;param name=&quot;cacheTime&quot;&gt;The cache time (Minutes).&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        bool Save(string key, object value, int cacheTime);

        /// &lt;summary&gt;
        /// Insert an item in the cache with the cacheTime.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The value.&lt;/param&gt;
        /// &lt;param name=&quot;cacheTime&quot;&gt;The cache time.&lt;/param&gt;
        /// &lt;returns&gt;&lt;c&gt;true&lt;/c&gt; if XXXX, &lt;c&gt;false&lt;/c&gt; otherwise.&lt;/returns&gt;
        bool Save&lt;T&gt;(string key, T value, TimeSpan cacheTime);

        /// &lt;summary&gt;
        /// Insert an Collection in the cache with the cacheTime.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;keyPrefix&quot;&gt;The key prefix.&lt;/param&gt;
        /// &lt;param name=&quot;collection&quot;&gt;The collection.&lt;/param&gt;
        /// &lt;param name=&quot;cacheTime&quot;&gt;The cache time.&lt;/param&gt;
        /// &lt;returns&gt;&lt;c&gt;true&lt;/c&gt; if XXXX, &lt;c&gt;false&lt;/c&gt; otherwise.&lt;/returns&gt;
        bool SaveCollection&lt;T&gt;(string keyPrefix, List&lt;T&gt; collection, TimeSpan cacheTime);

        /// &lt;summary&gt;
        /// Gets the item associated with this key if present.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;An object identifying the requested entry.&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The located value or null.&lt;/param&gt;
        /// &lt;returns&gt;True if the key was found.&lt;/returns&gt;
        bool TryGetValue(string key, out object value);

        /// &lt;summary&gt;
        /// Retrieves a cached object from the cache
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to identify this object&lt;/param&gt;
        /// &lt;returns&gt;The object from the database, or an exception if the object doesn't exist&lt;/returns&gt;
        object Get(string key);

        /// &lt;summary&gt;
        /// Retrieves a cached object from the cache.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to identify this object.&lt;/param&gt;
        /// &lt;returns&gt;T.&lt;/returns&gt;
        T Get&lt;T&gt;(string key);

        /// &lt;summary&gt;
        /// Gets a set of cached objects
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;keys&quot;&gt;All of the keys of the objects we wish to retrieve&lt;/param&gt;
        /// &lt;returns&gt;A key / value dictionary containing all of the keys and objects we wanted to retrieve&lt;/returns&gt;
        IDictionary&lt;string, object&gt; Get(string[] keys);

        /// &lt;summary&gt;
        /// Gets the collection.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;returns&gt;IEnumerable&amp;lt;T&amp;gt;.&lt;/returns&gt;
        IEnumerable&lt;T&gt; GetCollection&lt;T&gt;(string key);

        /// &lt;summary&gt;
        /// Retrieves a cached object using an indexers
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to identify this object&lt;/param&gt;
        /// &lt;returns&gt;The cached object&lt;/returns&gt;
        object this[string key] { get; set; }

        /// &lt;summary&gt;
        /// Removes an object from the cache with the specified key
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to identify this object&lt;/param&gt;
        /// &lt;returns&gt;True if the object was removed, false if it didn't exist or was unable to be removed&lt;/returns&gt;
        bool Remove(string key);

        /// &lt;summary&gt;
        /// Flushes this instance.
        /// &lt;/summary&gt;
        void Flush();

        /// &lt;summary&gt;
        /// 取得或是建立快取
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;The method.&lt;/param&gt;
        /// &lt;param name=&quot;cacheTime&quot;&gt;The cache time.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        Task&lt;T&gt; GetOrSaveAsync&lt;T&gt;(string key, Func&lt;Task&lt;T&gt;&gt; method, TimeSpan cacheTime);
    }
</code></pre><p>實作CacheProvider。</p>
<pre><code class="language-csharp=" data-lang="csharp=">/// &lt;summary&gt;
    /// abstract CacheProvider.
    /// &lt;/summary&gt;
    /// &lt;seealso cref=&quot;ICacheProvider&quot; /&gt;
    public abstract class CacheProvider : ICacheProvider
    {
        protected readonly TimeSpan DefaultDuration;

        protected CacheProvider(TimeSpan duration)
        {
            this.DefaultDuration = duration;
        }

        #region abstract ICacheProvider members

        /// &lt;summary&gt;
        /// Validates if an object with this key exists in the cache
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key of the object to check&lt;/param&gt;
        /// &lt;returns&gt;
        /// True if it exists, false if it doesn't
        /// &lt;/returns&gt;
        public abstract bool Exists(string key);

        /// &lt;summary&gt;
        /// Insert an item in the cache with the expiration that it will expire if not used past its window
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to map this object&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The object to insert&lt;/param&gt;
        /// &lt;param name=&quot;slidingExpiration&quot;&gt;The expiration window&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public abstract bool Save(string key, object value, TimeSpan slidingExpiration);

        /// &lt;summary&gt;
        /// Insert an item in the cache with the expiration that will expire at a specific point in time
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to map this object&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The object to insert&lt;/param&gt;
        /// &lt;param name=&quot;absoluteExpiration&quot;&gt;The DateTime in which this object will expire&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public abstract bool Save(string key, object value, DateTime absoluteExpiration);

        /// &lt;summary&gt;
        /// Saves the specified key.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The value.&lt;/param&gt;
        /// &lt;param name=&quot;cacheTime&quot;&gt;The cache time (Minutes).&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public abstract bool Save(string key, object value, int cacheTime);

        /// &lt;summary&gt;
        /// Insert an item in the cache with the CacheItemPolicy.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The value.&lt;/param&gt;
        /// &lt;param name=&quot;cacheTime&quot;&gt;The cache time.&lt;/param&gt;
        /// &lt;returns&gt;
        ///   &lt;c&gt;true&lt;/c&gt; if XXXX, &lt;c&gt;false&lt;/c&gt; otherwise.
        /// &lt;/returns&gt;
        public abstract bool Save&lt;T&gt;(string key, T value, TimeSpan cacheTime);

        /// &lt;summary&gt;
        /// Insert an Collection in the cache with the CacheItemPolicy.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;keyPrefix&quot;&gt;The key prefix.&lt;/param&gt;
        /// &lt;param name=&quot;collection&quot;&gt;The collection.&lt;/param&gt;
        /// &lt;param name=&quot;cacheTime&quot;&gt;The cache time.&lt;/param&gt;
        /// &lt;returns&gt;
        ///   &lt;c&gt;true&lt;/c&gt; if XXXX, &lt;c&gt;false&lt;/c&gt; otherwise.
        /// &lt;/returns&gt;
        public abstract bool SaveCollection&lt;T&gt;(string keyPrefix, List&lt;T&gt; collection, TimeSpan cacheTime);

        /// &lt;summary&gt;
        /// Gets the collection.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;returns&gt;
        /// IEnumerable&amp;lt;T&amp;gt;.
        /// &lt;/returns&gt;
        public abstract IEnumerable&lt;T&gt; GetCollection&lt;T&gt;(string key);

        /// &lt;summary&gt;
        /// Gets the item associated with this key if present.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;An object identifying the requested entry.&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The located value or null.&lt;/param&gt;
        /// &lt;returns&gt;True if the key was found.&lt;/returns&gt;
        public abstract bool TryGetValue(string key, out object value);

        /// &lt;summary&gt;
        /// Retrieves a cached object from the cache
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to identify this object&lt;/param&gt;
        /// &lt;returns&gt;
        /// The object from the database, or an exception if the object doesn't exist
        /// &lt;/returns&gt;
        public abstract object Get(string key);

        /// &lt;summary&gt;
        /// Retrieves a cached object from the cache.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to identify this object.&lt;/param&gt;
        /// &lt;returns&gt;
        /// T.
        /// &lt;/returns&gt;
        public abstract T Get&lt;T&gt;(string key);

        /// &lt;summary&gt;
        /// Gets a set of cached objects
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;keys&quot;&gt;All of the keys of the objects we wish to retrieve&lt;/param&gt;
        /// &lt;returns&gt;
        /// A key / value dictionary containing all of the keys and objects we wanted to retrieve
        /// &lt;/returns&gt;
        public abstract IDictionary&lt;string, object&gt; Get(string[] keys);

        /// &lt;summary&gt;
        /// Removes an object from the cache with the specified key
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to identify this object&lt;/param&gt;
        /// &lt;returns&gt;
        /// True if the object was removed, false if it didn't exist or was unable to be removed
        /// &lt;/returns&gt;
        public abstract bool Remove(string key);

        /// &lt;summary&gt;
        /// Flush this instance.
        /// &lt;/summary&gt;
        public abstract void Flush();

        #endregion

        #region Implementation of ICacheService

        /// &lt;summary&gt;
        /// Insert an item into the cache with no specifics as to how it will be used
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to map this object&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The value to be saved to the cache&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public bool Save(string key, object value)
        {
            return this.Save
            (
                key: key,
                value: value,
                slidingExpiration: this.GetDefaultPolicy()
            );
        }

        /// &lt;summary&gt;
        /// Gets or sets the &lt;see cref=&quot;System.Object&quot;/&gt; with the specified key.
        /// &lt;/summary&gt;
        /// &lt;value&gt;
        /// The &lt;see cref=&quot;System.Object&quot;/&gt;.
        /// &lt;/value&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public object this[string key]
        {
            get =&gt; this.Get(key);
            set =&gt; this.Save(key, value, this.GetDefaultPolicy());
        }

        #endregion

        #region Expiration Policy Helpers

        protected TimeSpan GetDefaultPolicy()
        {
            return CacheUtility.GetCacheItemExpiration(this.DefaultDuration);
        }

        public abstract Task&lt;T&gt; GetOrSaveAsync&lt;T&gt;(string key, Func&lt;Task&lt;T&gt;&gt; method, TimeSpan cacheTime);
            
        #endregion
    }
</code></pre><p>接下來就是開始製作我們記憶體快取實作的部分。</p>
<pre><code class="language-csharp=" data-lang="csharp=">    /// &lt;summary&gt;
    /// class MemoryCacheProvider.
    /// &lt;/summary&gt;
    /// &lt;seealso cref=&quot;CacheProvider&quot; /&gt;
    public class MemoryCacheProvider : CacheProvider
    {
        private readonly IMemoryCache _memoryCache;

        /// &lt;summary&gt;
        /// All keys of cache
        /// &lt;/summary&gt;
        /// &lt;remarks&gt;Dictionary value indicating whether a key still exists in cache&lt;/remarks&gt; 
        private static ConcurrentDictionary&lt;string, bool&gt; AllKeys;

        public static IReadOnlyCollection&lt;string&gt; Cachekeys
        {
            get { return AllKeys.Select(x =&gt; x.Key).ToList().AsReadOnly(); }
        }

        /// &lt;summary&gt;
        /// Cancellation token for clear cache
        /// &lt;/summary&gt;
        protected CancellationTokenSource CancellationTokenSource;

        static MemoryCacheProvider()
        {
            AllKeys = new ConcurrentDictionary&lt;string, bool&gt;();
        }

        public MemoryCacheProvider(IMemoryCache cache)
            : base(new TimeSpan(0, 20, 0))
        {
            this._memoryCache = cache;
            this.CancellationTokenSource = new CancellationTokenSource();
        }

        //-----------------------------------------------------------------------------------------

        private const string LockCacheKeyPrefix = &quot;##LockCacheKey##&quot;;

        private static object GetLockObject(string key)
        {
            var lockObjectKey = $&quot;{LockCacheKeyPrefix}{key}&quot;;

            var cache = new MemoryCache(new MemoryCacheOptions());

            lock (cache)
            {
                if (cache.Get(lockObjectKey) != null)
                {
                    return cache.Get(lockObjectKey);
                }

                var options = new MemoryCacheEntryOptions().SetSlidingExpiration(new TimeSpan(0, 10, 0));
                cache.Set(lockObjectKey, new object(), options);
            }

            return cache.Get(lockObjectKey);
        }

        //-----------------------------------------------------------------------------------------

        /// &lt;summary&gt;
        /// Create entry options to item of memory cache
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;cacheTime&quot;&gt;Cache time&lt;/param&gt;
        protected MemoryCacheEntryOptions GetMemoryCacheEntryOptions(TimeSpan cacheTime)
        {
            var expirationToken = new CancellationChangeToken
            (
                new CancellationTokenSource(cacheTime + new TimeSpan(0, 0, 0, 1)).Token
            );

            var options = new MemoryCacheEntryOptions()
                          .SetAbsoluteExpiration(cacheTime)
                          .AddExpirationToken(expirationToken)
                          .RegisterPostEvictionCallback(this.PostEviction, state: this);

            return options;
        }

        /// &lt;summary&gt;
        /// Add key to dictionary
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;Key of cached item&lt;/param&gt;
        /// &lt;returns&gt;Itself key&lt;/returns&gt;
        protected string AddKey(string key)
        {
            AllKeys.TryAdd(key, true);
            return key;
        }

        /// &lt;summary&gt;
        /// Remove key from dictionary
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;Key of cached item&lt;/param&gt;
        /// &lt;returns&gt;Itself key&lt;/returns&gt;
        protected string RemoveKey(string key)
        {
            this.TryRemoveKey(key);
            return key;
        }

        /// &lt;summary&gt;
        /// Try to remove a key from dictionary, or mark a key as not existing in cache
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;Key of cached item&lt;/param&gt;
        protected void TryRemoveKey(string key)
        {
            // try to remove key from dictionary
            if (AllKeys.TryRemove(key, out _).Equals(false))
            {
                // if not possible to remove key from dictionary, then try to mark key as not existing in cache
                AllKeys.TryUpdate(key, false, true);
            }
        }

        /// &lt;summary&gt;
        /// Remove all keys marked as not existing
        /// &lt;/summary&gt;
        private void ClearKeys()
        {
            foreach (var key in AllKeys.Where(p =&gt; !p.Value).Select(p =&gt; p.Key).ToList())
            {
                this.RemoveKey(key);
            }
        }

        /// &lt;summary&gt;
        /// Post eviction
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;Key of cached item&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;Value of cached item&lt;/param&gt;
        /// &lt;param name=&quot;reason&quot;&gt;Eviction reason&lt;/param&gt;
        /// &lt;param name=&quot;state&quot;&gt;State&lt;/param&gt;
        private void PostEviction(object key, object value, EvictionReason reason, object state)
        {
            // if cached item just change, then nothing doing
            if (reason == EvictionReason.Replaced)
            {
                return;
            }

            // try to remove all keys marked as not existing
            this.ClearKeys();

            // try to remove this key from dictionary
            this.TryRemoveKey(key.ToString());
        }

        //-----------------------------------------------------------------------------------------

        /// &lt;summary&gt;
        /// Existses the specified key.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;key&lt;/exception&gt;
        public override bool Exists(string key)
        {
            if (string.IsNullOrWhiteSpace(key))
            {
                throw new ArgumentNullException(nameof(key));
            }

            lock (GetLockObject(key))
            {
                return this._memoryCache.TryGetValue(key, out _);
            }
        }

        /// &lt;summary&gt;
        /// Insert an item in the cache with the expiration that it will expire if not used past its window
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to map this object&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The object to insert&lt;/param&gt;
        /// &lt;param name=&quot;slidingExpiration&quot;&gt;The expiration window&lt;/param&gt;
        /// &lt;returns&gt;&lt;c&gt;true&lt;/c&gt; if XXXX, &lt;c&gt;false&lt;/c&gt; otherwise.&lt;/returns&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;
        /// key
        /// or
        /// value
        /// &lt;/exception&gt;
        public override bool Save(string key, object value, TimeSpan slidingExpiration)
        {
            if (string.IsNullOrWhiteSpace(key))
            {
                throw new ArgumentNullException(nameof(key));
            }

            if (value is null)
            {
                throw new ArgumentNullException(nameof(value));
            }

            lock (GetLockObject(key))
            {
                bool result;

                try
                {
                    this._memoryCache.Set
                    (
                        key: this.AddKey(key),
                        value: value,
                        options: new MemoryCacheEntryOptions().SetSlidingExpiration(slidingExpiration)
                    );

                    result = true;
                }
                catch
                {
                    result = false;
                }

                return result;
            }
        }

        /// &lt;summary&gt;
        /// Insert an item in the cache with the expiration that will expire at a specific point in time
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to map this object&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The object to insert&lt;/param&gt;
        /// &lt;param name=&quot;absoluteExpiration&quot;&gt;The DateTime in which this object will expire&lt;/param&gt;
        /// &lt;returns&gt;&lt;c&gt;true&lt;/c&gt; if XXXX, &lt;c&gt;false&lt;/c&gt; otherwise.&lt;/returns&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;
        /// key
        /// or
        /// value
        /// &lt;/exception&gt;
        public override bool Save(string key, object value, DateTime absoluteExpiration)
        {
            if (string.IsNullOrWhiteSpace(key))
            {
                throw new ArgumentNullException(nameof(key));
            }

            if (value is null)
            {
                throw new ArgumentNullException(nameof(value));
            }

            lock (GetLockObject(key))
            {
                bool result;

                try
                {
                    this._memoryCache.Set
                    (
                        key: this.AddKey(key),
                        value: value,
                        options: this.GetMemoryCacheEntryOptions(new TimeSpan(absoluteExpiration.Ticks))
                    );

                    result = true;
                }
                catch
                {
                    result = false;
                }

                return result;
            }
        }

        /// &lt;summary&gt;
        /// Saves the specified key.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The value.&lt;/param&gt;
        /// &lt;param name=&quot;cacheTime&quot;&gt;The cache time (Minutes).&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;
        /// key
        /// or
        /// value
        /// &lt;/exception&gt;
        public override bool Save(string key, object value, int cacheTime)
        {
            if (string.IsNullOrWhiteSpace(key))
            {
                throw new ArgumentNullException(nameof(key));
            }

            if (value is null)
            {
                throw new ArgumentNullException(nameof(value));
            }

            lock (GetLockObject(key))
            {
                bool result;

                try
                {
                    this._memoryCache.Set
                    (
                        this.AddKey(key),
                        value,
                        new MemoryCacheEntryOptions().SetAbsoluteExpiration(TimeSpan.FromMinutes(cacheTime))
                    );

                    result = true;
                }
                catch
                {
                    result = false;
                }

                return result;
            }
        }

        /// &lt;summary&gt;
        /// Insert an item in the cache with the cacheTime.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The value.&lt;/param&gt;
        /// &lt;param name=&quot;cacheTime&quot;&gt;The cache time.&lt;/param&gt;
        /// &lt;returns&gt;
        ///   &lt;c&gt;true&lt;/c&gt; if XXXX, &lt;c&gt;false&lt;/c&gt; otherwise.
        /// &lt;/returns&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;
        /// key
        /// or
        /// value
        /// &lt;/exception&gt;
        public override bool Save&lt;T&gt;(string key, T value, TimeSpan cacheTime)
        {
            if (string.IsNullOrWhiteSpace(key))
            {
                throw new ArgumentNullException(nameof(key));
            }

            if (value == null)
            {
                throw new ArgumentNullException(nameof(value));
            }

            lock (GetLockObject(key))
            {
                bool result;

                try
                {
                    this._memoryCache.Set
                    (
                        key: this.AddKey(key),
                        value: (object)value,
                        options: this.GetMemoryCacheEntryOptions(cacheTime)
                    );

                    result = true;
                }
                catch
                {
                    result = false;
                }

                return result;
            }
        }

        /// &lt;summary&gt;
        /// Insert an Collection in the cache with the cacheTime.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;keyPrefix&quot;&gt;The key prefix.&lt;/param&gt;
        /// &lt;param name=&quot;collection&quot;&gt;The collection.&lt;/param&gt;
        /// &lt;param name=&quot;cacheTime&quot;&gt;The cache time.&lt;/param&gt;
        /// &lt;returns&gt;
        ///   &lt;c&gt;true&lt;/c&gt; if XXXX, &lt;c&gt;false&lt;/c&gt; otherwise.
        /// &lt;/returns&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;
        /// keyPrefix
        /// or
        /// collection
        /// &lt;/exception&gt;
        public override bool SaveCollection&lt;T&gt;(string keyPrefix, List&lt;T&gt; collection, TimeSpan cacheTime)
        {
            if (string.IsNullOrWhiteSpace(keyPrefix))
            {
                throw new ArgumentNullException(nameof(keyPrefix));
            }

            if (collection is null || collection.Any().Equals(false))
            {
                throw new ArgumentNullException(nameof(collection));
            }

            lock (GetLockObject(keyPrefix))
            {
                bool result;

                try
                {
                    this._memoryCache.Set
                    (
                        key: this.AddKey(keyPrefix),
                        value: collection,
                        options: new MemoryCacheEntryOptions().SetAbsoluteExpiration(cacheTime)
                    );

                    result = true;
                }
                catch
                {
                    result = false;
                }

                return result;
            }
        }

        /// &lt;summary&gt;
        /// Gets the item associated with this key if present.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;An object identifying the requested entry.&lt;/param&gt;
        /// &lt;param name=&quot;value&quot;&gt;The located value or null.&lt;/param&gt;
        /// &lt;returns&gt;True if the key was found.&lt;/returns&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;key&lt;/exception&gt;
        public override bool TryGetValue(string key, out object value)
        {
            if (string.IsNullOrWhiteSpace(key))
            {
                throw new ArgumentNullException(nameof(key));
            }

            lock (GetLockObject(key))
            {
                var result = this._memoryCache.TryGetValue(key, out var cachedValue);
                value = result ? cachedValue : null;

                return result;
            }
        }

        /// &lt;summary&gt;
        /// Retrieves a cached object from the cache
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to identify this object&lt;/param&gt;
        /// &lt;returns&gt;
        /// The object from the database, or an exception if the object doesn't exist
        /// &lt;/returns&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;key&lt;/exception&gt;
        public override object Get(string key)
        {
            if (string.IsNullOrWhiteSpace(key))
            {
                throw new ArgumentNullException(nameof(key));
            }

            lock (GetLockObject(key))
            {
                return this._memoryCache.TryGetValue(key, out var value) ? value : null;
            }
        }

        /// &lt;summary&gt;
        /// Retrieves a cached object from the cache.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to identify this object.&lt;/param&gt;
        /// &lt;returns&gt;
        /// T.
        /// &lt;/returns&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;key&lt;/exception&gt;
        public override T Get&lt;T&gt;(string key)
        {
            if (string.IsNullOrWhiteSpace(key))
            {
                throw new ArgumentNullException(nameof(key));
            }

            lock (GetLockObject(key))
            {
                if (this._memoryCache.TryGetValue(key, out var cachedObject).Equals(false))
                {
                    return default(T);
                }

                if (cachedObject is T variable)
                {
                    return variable;
                }

                try
                {
                    return (T)Convert.ChangeType(cachedObject, typeof(T));
                }
                catch (InvalidCastException)
                {
                    return default(T);
                }
            }
        }

        /// &lt;summary&gt;
        /// Gets a set of cached objects
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;keys&quot;&gt;All of the keys of the objects we wish to retrieve&lt;/param&gt;
        /// &lt;returns&gt;
        /// A key / value dictionary containing all of the keys and objects we wanted to retrieve
        /// &lt;/returns&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;keys&lt;/exception&gt;
        public override IDictionary&lt;string, object&gt; Get(string[] keys)
        {
            if (keys is null || keys.Any().Equals(false))
            {
                throw new ArgumentNullException(nameof(keys));
            }

            return keys.ToDictionary(key =&gt; key, this.Get);
        }

        /// &lt;summary&gt;
        /// Gets the collection.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;returns&gt;
        /// IEnumerable&amp;lt;T&amp;gt;.
        /// &lt;/returns&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;key&lt;/exception&gt;
        public override IEnumerable&lt;T&gt; GetCollection&lt;T&gt;(string key)
        {
            if (string.IsNullOrWhiteSpace(key))
            {
                throw new ArgumentNullException(nameof(key));
            }

            lock (GetLockObject(key))
            {
                if (this._memoryCache.TryGetValue(key, out var cachedObject).Equals(false))
                {
                    return default(IEnumerable&lt;T&gt;);
                }

                try
                {
                    return (IEnumerable&lt;T&gt;)cachedObject;
                }
                catch (InvalidCastException)
                {
                    return default(IEnumerable&lt;T&gt;);
                }
            }
        }

        /// &lt;summary&gt;
        /// Removes an object from the cache with the specified key
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key used to identify this object&lt;/param&gt;
        /// &lt;returns&gt;
        /// True if the object was removed, false if it didn't exist or was unable to be removed
        /// &lt;/returns&gt;
        /// &lt;exception cref=&quot;ArgumentNullException&quot;&gt;key&lt;/exception&gt;
        public override bool Remove(string key)
        {
            if (string.IsNullOrWhiteSpace(key))
            {
                throw new ArgumentNullException(nameof(key));
            }

            lock (GetLockObject(key))
            {
                if (this.Exists(key).Equals(false))
                {
                    return false;
                }

                this._memoryCache.Remove(this.RemoveKey(key));

                return this.Exists(key).Equals(false);
            }
        }

        /// &lt;summary&gt;
        /// Flush this instance.
        /// &lt;/summary&gt;
        public override void Flush()
        {
            foreach (var key in AllKeys.Keys)
            {
                this.Remove(key);
            }
        }

        /// &lt;summary&gt;
        /// Gets the or save asynchronous.
        /// &lt;/summary&gt;
        /// &lt;typeparam name=&quot;T&quot;&gt;&lt;/typeparam&gt;
        /// &lt;param name=&quot;key&quot;&gt;The key.&lt;/param&gt;
        /// &lt;param name=&quot;method&quot;&gt;The method.&lt;/param&gt;
        /// &lt;param name=&quot;options&quot;&gt;The options.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        /// &lt;exception cref=&quot;NotImplementedException&quot;&gt;&lt;/exception&gt;
        public override async Task&lt;T&gt; GetOrSaveAsync&lt;T&gt;(string key, Func&lt;Task&lt;T&gt;&gt; method, TimeSpan cacheTime)
        {
            if (this.Exists(key))
            {
                return this.Get&lt;T&gt;(key);
            }

            var result = await method();

            this.Save&lt;T&gt;(key, result, cacheTime);
            return result;
        }
    }
</code></pre><p>上面會看到有使用Lock的相關用法，大師們都有介紹小弟就不獻醜了，相關原因可以參考：</p>
<ul>
<li><a href="https://blog.darkthread.net/blog/improved-getcachabledata/">改良式GetCachableData可快取查詢函式</a>。</li>
<li><a href="https://raychiutw.github.io/2019/%E9%9A%A8%E6%89%8B-Design-Pattern-5-%E9%9B%99%E9%87%8D%E6%AA%A2%E6%9F%A5%E9%8E%96%E5%AE%9A%E6%A8%A1%E5%BC%8F-Double-Checked-Locking-Pattern/">隨手 Design Pattern (5) - 雙重檢查鎖定模式 </a>。</li>
</ul>
<p>接下來就可以來使用記憶體快取了，來改寫一下Repository。</p>
<pre><code class="language-csharp=" data-lang="csharp=">public class StationRepository : IStationRepository
    {
        private readonly string _connectionString;
        private readonly IDatabaseHelper _databaseHelper;
        private readonly ICacheProvider _cacheProvider;

        /// &lt;summary&gt;
        /// Initializes a new instance of the &lt;see cref=&quot;StationRepository&quot;/&gt; class.
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;connectionString&quot;&gt;The connection string.&lt;/param&gt;
        /// &lt;param name=&quot;databaseHelper&quot;&gt;The database helper.&lt;/param&gt;
        public StationRepository(
            string connectionString,
            IDatabaseHelper databaseHelper,
            ICacheProvider cacheProvider)
        {
            this._connectionString = connectionString;
            this._databaseHelper = databaseHelper;
            this._cacheProvider = cacheProvider;
        }

        /// &lt;summary&gt;
        /// 取得全部Youbike站點
        /// &lt;/summary&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public async Task&lt;IEnumerable&lt;StationDataModel&gt;&gt; GetAllStationAsync()
        {
            var stepName = $&quot;{nameof(StationRepository)}.{nameof(this.GetAllStationAsync)}&quot;;
            using (ProfilingSession.Current.Step(stepName))
            {
                var sql = @&quot;SELECT [StationNo]
                              ,[StationName]
                              ,[Total]
                              ,[BikeAmount]
                              ,[StationArea]
                              ,[ModifyDate]
                              ,[Latitude]
                              ,[Longitude]
                              ,[Address]
                              ,[StationAreaEnglish]
                              ,[StationNameEnglish]
                              ,[AddressEnglish]
                              ,[Available]
                              ,[Active]
                              ,[SrcUpdateTime]
                              ,[UpdateTime]
                              ,[InfoTime]
                              ,[InfoDate]
                          FROM [Northwind].[dbo].[YoubikeStation]&quot;;


                var result =
                    await this._cacheProvider.GetOrSaveAsync&lt;IEnumerable&lt;StationDataModel&gt;&gt;
                    (
                        key: &quot;StationRepository::Exist::GetAllStationAsync&quot;,
                        async () =&gt;
                        {
                            using (var conn = this._databaseHelper.GetConnection(this._connectionString))
                            {
                                var stations = await conn.QueryAsync&lt;StationDataModel&gt;(sql);

                                return stations;
                            }
                        },
                        cacheTime: CacheUtility.GetCacheItemExpiration1Min());

                return result;
            }  
        }

        /// &lt;summary&gt;
        /// 取得指定Youbike站點
        /// &lt;/summary&gt;
        /// &lt;param name=&quot;stationNo&quot;&gt;The station no.&lt;/param&gt;
        /// &lt;returns&gt;&lt;/returns&gt;
        public async Task&lt;StationDataModel&gt; GetStationAsync(string stationNo)
        {
            var stepName = $&quot;{nameof(StationRepository)}.{nameof(this.GetStationAsync)}&quot;;
            using (ProfilingSession.Current.Step(stepName))
            {
                stationNo.CheckNotNullOrEmpty(nameof(stationNo));

                var stations = await this.GetAllStationAsync();
                var result = stations.FirstOrDefault(rows =&gt; rows.StationNo == stationNo);

                return result;
            }   
        }
    }
</code></pre><p>因為上面已將所有站點加入快取，GetStationAsync這個方法我就使用拿取原本的資料塞選我們使用的站點。</p>
<p>StartUp地方加入快取設定。</p>
<pre><code class="language-csharp=" data-lang="csharp=">services.AddMemoryCache();
services.AddSingleton&lt;IMemoryCache&gt;(sp =&gt; new MemoryCache(new MemoryCacheOptions()));
services.AddSingleton&lt;ICacheProvider&gt;(
                sp =&gt; 
                {
                    return new MemoryCacheProvider(
                        sp.GetRequiredService&lt;IMemoryCache&gt;());
                });
services.AddSingleton&lt;IDatabaseHelper, DatabaseHelper&gt;()
                .AddScoped&lt;IStationRepository, StationRepository&gt;(
                sp =&gt;
                {
                    return new StationRepository(
                        northwindConnection,
                        sp.GetRequiredService&lt;IDatabaseHelper&gt;(),
                        sp.GetRequiredService&lt;ICacheProvider&gt;());
                    
                });
</code></pre><p><img src="https://i.imgur.com/u855VnC.jpg" alt=""></p>
<p>實際測試看看：<br>
撈取所有站點資料。<br>
<img src="https://i.imgur.com/9iHdAjc.jpg" alt=""></p>
<p>CoreProfiler監看。<br>
連續要資料兩次的結果：<br>
<img src="https://i.imgur.com/Z88hHgB.jpg" alt=""></p>
<p>第一次進DB撈取資料花了701毫秒：<br>
<img src="https://i.imgur.com/ue9Y68v.jpg" alt=""></p>
<p>第二次進入快取撈資料只花了19毫秒：<br>
<img src="https://i.imgur.com/03trm8Y.jpg" alt=""></p>
<h2 id="後記">後記</h2>
<p>這邊的程式大部分都是觀看公司大神、前輩寫過的Code做為參考，自己再試著加入現有的程式測試，為了保持原始程式乾淨供對照，我切了分支出來做示範，歡迎取用。<br>
<a href="https://github.com/sunnyday0932/YouBikeService/tree/feature/MemoryCache">程式連結。</a></p>
<h2 id="參考連結">參考連結</h2>
<p>快取：</p>
<ul>
<li>1、<a href="https://docs.microsoft.com/zh-tw/aspnet/core/performance/caching/memory?view=aspnetcore-5.0">ASP.NET Core 中的快取記憶體</a></li>
<li>2、<a href="https://dotblogs.com.tw/daniel/2018/07/09/143757">Asp.net使用快取 (一)</a>。</li>
<li>3、<a href="https://dotblogs.com.tw/daniel/2018/07/09/143902">Asp.net使用快取 (二)</a>。</li>
<li>4、<a href="https://blog.johnwu.cc/article/ironman-day20-asp-net-core-caching-redis-session.html">ASP.NET Core 2 系列 - 快取機制及 Redis Session</a>。</li>
<li>5、<a href="https://dotblogs.com.tw/felixblog/2019/12/09/142948">搞懂記憶體快取 Memory Cache</a>。</li>
</ul>
<p>快取鎖：</p>
<ul>
<li>1、<a href="https://blog.darkthread.net/blog/improved-getcachabledata/">改良式GetCachableData可快取查詢函式</a>。</li>
<li>2、<a href="https://raychiutw.github.io/2019/%E9%9A%A8%E6%89%8B-Design-Pattern-5-%E9%9B%99%E9%87%8D%E6%AA%A2%E6%9F%A5%E9%8E%96%E5%AE%9A%E6%A8%A1%E5%BC%8F-Double-Checked-Locking-Pattern/">隨手 Design Pattern (5) - 雙重檢查鎖定模式</a>。</li>
</ul>

    </div>

    <div class="post-copyright">
             
            <p class="copyright-item">
                <span>Author:</span>
                <span>Sian </span>
                </p>
            
           
             
            <p class="copyright-item">
                    <span>Link:</span>
                    <a href=https://sunnyday0932.github.io/2021/webapi-%E5%8A%A0%E5%85%A5%E5%BF%AB%E5%8F%96-1/>https://sunnyday0932.github.io/2021/webapi-%E5%8A%A0%E5%85%A5%E5%BF%AB%E5%8F%96-1/</span>
            </p>
            
             
            <p class="copyright-item lincese">
                本文採用<a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知識共享署名-非商業性使用 4.0 國際許可協議</a>進行許可
            </p>
            
    </div>

  
    <div class="post-tags">
        
            <section>
            <i class="iconfont icon-tag"></i>Tag(s): 
            
            <span class="tag"><a href="https://sunnyday0932.github.io/tags/csharp/">
                    #csharp</a></span>
            
            <span class="tag"><a href="https://sunnyday0932.github.io/tags/core/">
                    #Core</a></span>
            
            <span class="tag"><a href="https://sunnyday0932.github.io/tags/dotnet/">
                    #dotnet</a></span>
            
            <span class="tag"><a href="https://sunnyday0932.github.io/tags/cache/">
                    #Cache</a></span>
            
            </section>
        
        <section>
                <a href="javascript:window.history.back();">back</a></span> · 
                <span><a href="https://sunnyday0932.github.io">home</a></span>
        </section>
    </div>

    <div class="post-nav">
        
        <a href="https://sunnyday0932.github.io/2021/coreprofiler-%E7%9B%A3%E7%9C%8Bwebapi%E6%95%88%E8%83%BD%E7%9A%84%E5%B7%A5%E5%85%B7/" class="prev" rel="prev" title="CoreProfiler - 監看WebApi效能的工具"><i class="iconfont icon-left"></i>&nbsp;CoreProfiler - 監看WebApi效能的工具</a>
         
        
        <a href="https://sunnyday0932.github.io/2021/webapi-%E5%8A%A0%E5%85%A5%E5%BF%AB%E5%8F%96-2%E4%BD%BF%E7%94%A8%E8%A3%9D%E9%A3%BE%E8%80%85%E6%A8%A1%E5%BC%8F/" class="next" rel="next" title="WebApi 加入快取 - 2(使用裝飾者模式)">WebApi 加入快取 - 2(使用裝飾者模式)&nbsp;<i class="iconfont icon-right"></i></a>
        
    </div>

    <div class="post-comment">
          
                 
                     <div id="disqus_thread"></div>
<script type="application/javascript">
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "Sian" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
                 
          
    </div>

    
</article>
          </div>
		   </main>
      <footer class="footer">
    <div class="copyright">
        &copy;
        
        <span itemprop="copyrightYear">2020 - 2021</span>
        
        <span class="with-love">
    	 
         </span>
         
            <span class="author" itemprop="copyrightHolder"><a href="https://sunnyday0932.github.io">Sian</a> | </span> 
         

         
        <span>Powered by <a href="https://gohugo.io/" target="_blank" rel="external nofollow">Hugo</a> & <a href="https://github.com/liuzc/leaveit" target="_blank" rel="external nofollow">LeaveIt</a></span> 
        <span id="busuanzi_container_site_pv">
            總瀏覽<span id="busuanzi_value_site_pv"></span>次
        </span>
    </div>
</footer>












    
     <link href="//lib.baomitu.com/lightgallery/1.6.11/css/lightgallery.min.css" rel="stylesheet">  
      
     <script src="/js/vendor_gallery.min.js" async="" ></script>
    
  



     </div>
  </body>
</html>
